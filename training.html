<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Train Model - ExoLiX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="scss/dark-theme.scss" />
</head>
<body>
  <!-- Navigation -->
  <div id="nav-container"></div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold mb-6 text-white">Train Exoplanet Classification Model</h1>
    
    <!-- Data Info -->
    <div class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4 text-white">Training Dataset</h2>
      <div id="dataInfo" class="space-y-2">
        <p class="text-gray-300">Loading data...</p>
      </div>
    </div>
    <!-- Mode Status + Change Control (Redesigned) -->
    <div id="modeStatusBar" class="hidden mb-6 -mt-2" aria-live="polite">
      <div class="flex flex-col md:flex-row md:items-stretch gap-3">
        <div id="modeStatusPanel" class="flex flex-1 items-center gap-4 rounded-lg border border-gray-700/70 bg-gray-800/50 px-4 py-3 shadow-inner backdrop-blur-sm transition-colors">
          <span id="modeStatusIcon" class="flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-gray-700 text-sm font-semibold text-gray-300 tracking-wide select-none">--</span>
          <div class="min-w-0">
            <div id="modeStatusTitle" class="text-sm font-semibold text-white">Training Mode</div>
            <div id="modeStatusSubtitle" class="text-xs text-gray-400 mt-0.5">Select a mode below to begin.</div>
          </div>
        </div>
        <div class="flex items-center">
          <button id="changeModeBtn" class="hidden h-full px-5 py-2.5 rounded-lg text-xs font-medium tracking-wide border border-gray-700/70 bg-gray-900/70 hover:bg-gray-800 hover:border-gray-600 text-gray-200 shadow-sm transition focus:outline-none focus:ring-2 focus:ring-offset-0 focus:ring-blue-500/50 disabled:opacity-40 disabled:cursor-not-allowed" title="Change training input mode">
            <span class="hidden sm:inline">Change Mode</span><span class="sm:hidden">Change</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Input Mode Selection (Large Buttons) -->
    <div id="inputModeCard" class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-5 text-white">Select Training Input Mode</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <button id="chooseRawMode" class="group relative w-full text-left bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700/70 hover:border-blue-500/70 hover:from-gray-700 hover:to-gray-800 rounded-xl p-5 transition shadow-md hover:shadow-blue-500/10">
          <div class="flex items-start gap-4">
            <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-blue-600/20 text-blue-300 font-semibold text-lg group-hover:bg-blue-600/30">R</div>
            <div>
              <p class="font-semibold text-white mb-1">Raw Tabular Features</p>
              <p class="text-xs text-gray-400 leading-snug">Use the engineered numeric features directly with the legacy 1024â†’64â†’8 MLP.</p>
            </div>
          </div>
          <div class="absolute top-3 right-3 text-[10px] tracking-wide uppercase text-gray-500 group-hover:text-blue-300">Baseline</div>
        </button>
        <button id="chooseEmbeddingMode" class="group relative w-full text-left bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700/70 hover:border-purple-500/70 hover:from-gray-700 hover:to-gray-800 rounded-xl p-5 transition shadow-md hover:shadow-purple-500/10">
          <div class="flex items-start gap-4">
            <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-purple-600/20 text-purple-300 font-semibold text-lg group-hover:bg-purple-600/30">E</div>
            <div>
              <p class="font-semibold text-white mb-1">LLM Embedding Mode</p>
              <p class="text-xs text-gray-400 leading-snug">Generate a semantic embedding from a prompt template, then train the same MLP on that embedding matrix.</p>
            </div>
          </div>
          <div class="absolute top-3 right-3 text-[10px] tracking-wide uppercase text-gray-500 group-hover:text-purple-300">Semantic</div>
        </button>
      </div>
      <p class="mt-5 text-xs text-gray-400">After selecting a mode this panel will hide. For embeddings you'll configure the prompt before training.</p>
    </div>

    <!-- LLM Prompt Builder -->
    <div class="card rounded-xl p-6 mb-6 hidden" id="promptBuilderCard">
      <div class="flex items-start justify-between flex-wrap gap-4">
        <h2 class="text-xl font-semibold text-white">LLM Prompt Template</h2>
        <div class="flex gap-3 text-xs">
          <button id="pbGenerateEmbedding" class="btn-primary px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">Generate Embedding</button>
          <button id="pbClearEmbedding" class="px-4 py-2 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 disabled:opacity-50 disabled:cursor-not-allowed">Reset</button>
        </div>
      </div>
      <div id="llmEmbeddingSummary" class="mt-3 hidden text-xs text-green-300"></div>
      <p class="text-xs text-gray-400 mt-2">Compose a descriptive instruction referencing features with placeholders like <code>{{0}}</code>, <code>{{1}}</code>. Click feature pills to insert placeholders at the cursor.</p>
      <div class="mt-6 grid md:grid-cols-12 gap-6">
        <!-- Feature pills -->
        <div class="md:col-span-4 lg:col-span-3">
          <h3 class="text-sm font-semibold text-gray-200 mb-3">Features</h3>
          <div id="pbFeaturePills" class="flex flex-wrap gap-2"></div>
          <div class="mt-4 text-xs text-gray-500" id="pbFeatureMeta"></div>
        </div>
        <!-- Editor -->
        <div class="md:col-span-8 lg:col-span-9">
          <div id="pbEditor" class="relative">
            <div id="pbTemplateEditor" class="min-h-[220px] w-full rounded border border-gray-700 bg-gray-900 p-4 text-sm text-gray-200 focus:outline-none prose prose-invert max-w-none" contenteditable="true" spellcheck="false"></div>
            <div class="absolute top-2 right-2 text-[10px] text-gray-500">Rich Text</div>
          </div>
          <div class="mt-2 flex justify-between text-xs text-gray-400">
            <span id="pbPlaceholderHint">Use placeholders like {{0}}.</span>
            <span id="pbCharCount">0 chars</span>
          </div>
          <div id="pbEditorError" class="mt-2 text-xs text-red-400 hidden"></div>
        </div>
      </div>
      <div class="mt-6 hidden" id="pbProgressWrap">
        <div class="flex justify-between text-xs text-gray-400 mb-1">
          <span id="pbProgLabel">Preparingâ€¦</span>
          <span id="pbProgTime">--s</span>
        </div>
        <div class="w-full h-2 bg-gray-800 rounded">
          <div id="pbProgFill" class="h-2 bg-blue-500 rounded" style="width:0%"></div>
        </div>
      </div>
      <div id="pbEmbeddingPreview" class="mt-6 hidden">
        <h3 class="text-sm font-semibold text-gray-200 mb-2">Embedding Preview</h3>
        <pre class="text-xs bg-gray-900 border border-gray-800 rounded p-3 overflow-x-auto whitespace-pre-wrap" id="pbEmbedPreviewBlock"></pre>
      </div>
    </div>

    <!-- Training Configuration (relocated below prompt builder, hidden until mode ready) -->
    <div id="trainingConfigCard" class="card rounded-xl p-6 mb-6 hidden">
      <h2 class="text-xl font-semibold mb-4 text-white">Training Configuration</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Epochs</label>
          <input id="epochs" type="number" value="50" min="1" class="w-full px-3 py-2 border border-gray-700 rounded-md bg-gray-900 text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Learning Rate</label>
          <input id="learningRate" type="number" value="0.0001" step="0.0001" class="w-full px-3 py-2 border border-gray-700 rounded-md bg-gray-900 text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Batch Size</label>
          <input id="batchSize" type="number" value="512" min="1" class="w-full px-3 py-2 border border-gray-700 rounded-md bg-gray-900 text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Validation Split</label>
          <input id="validationSplit" type="number" value="0.15" step="0.05" min="0" max="0.5" class="w-full px-3 py-2 border border-gray-700 rounded-md bg-gray-900 text-white">
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap gap-4">
      <button id="startTraining" class="hidden btn-primary px-6 py-3 rounded-lg font-semibold disabled:bg-gray-700 disabled:cursor-not-allowed transition">
        Start Training
      </button>
      <button id="downloadData" class="px-4 py-2 text-gray-400 hover:bg-gray-800 rounded transition disabled:opacity-50 disabled:cursor-not-allowed">
        ðŸ“¥ Download Preprocessed Data
      </button>
    </div>

    <!-- Training Status -->
    <div id="trainingStatus" class="mt-6 card rounded-xl p-6 hidden">
      <h2 class="text-xl font-semibold mb-4 text-white">Training Status</h2>
      <div id="statusContent" class="text-gray-300">
        <p>Training will begin when you click "Start Training"...</p>
      </div>
      <!-- Post training actions now injected directly into status message container -->
    </div>
  </div>

  <script type="module">
    import { loadNavigation } from './shared.js';
    import { initStarfield } from './starfield.js';
    loadNavigation('training');
    initStarfield();
  </script>
  <script type="module" src="training.js"></script>
  <script type="module" src="promptflow.js"></script>
</body>
</html>
